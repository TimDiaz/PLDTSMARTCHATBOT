var wss = require("nodejs-websocket")
const clustering = require('../clustering');
const LoggingEvent = require('../LoggingEvent');

const DELIMITER = '__LOG4JS__';

module.exports.configure = (config) => {  
    const server = wss.createServer(function (socket){
      let dataSoFar = '';
      socket.on('text', (data) => {
         console.log(data);
        if (data) {
          dataSoFar += data;
          if (dataSoFar.indexOf(DELIMITER)) {
            const events = dataSoFar.split(DELIMITER);
            if (!dataSoFar.endsWith(DELIMITER)) {
              dataSoFar = events.pop();
            } else {
              dataSoFar = '';
            }
            events
              .filter((e) => {console.log(e.length); return e.length })
              .forEach((e) => {                
                clustering.send(LoggingEvent.deserialise(e));
                socket.sendText("RECEIVED!!!")
              });
          } else {
            dataSoFar = '';
          }
        }
      });
      socket.on('error', function(error){
        //console.log(`Error: ${error}`);
      })
      socket.on('close', function (code, reason) {
          // console.log(`Connection closed code ${code} - reason: ${reason}`)
      });
    }).listen(config.port || 5000, function(){
      console.log(`Start listening to port: ${config.port || 5000}`)
    });
    
  
    // return this;
    return {
      shutdown: (cb) => {
        server.close();
      },
    };
  };